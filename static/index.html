<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude History Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .message-content { white-space: pre-wrap; word-break: break-word; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .markdown-body { color: #e5e7eb; line-height: 1.6; }
        .markdown-body h1 { font-size: 1.5rem; font-weight: bold; margin: 1rem 0; color: #fff; border-bottom: 1px solid #374151; padding-bottom: 0.5rem; }
        .markdown-body h2 { font-size: 1.25rem; font-weight: bold; margin: 1rem 0; color: #a78bfa; }
        .markdown-body h3 { font-size: 1.1rem; font-weight: bold; margin: 0.75rem 0; color: #60a5fa; }
        .markdown-body p { margin: 0.5rem 0; }
        .markdown-body ul, .markdown-body ol { margin: 0.5rem 0; padding-left: 1.5rem; }
        .markdown-body li { margin: 0.25rem 0; }
        .markdown-body code { background: #1f2937; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.875rem; }
        .markdown-body pre { background: #1f2937; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        .markdown-body pre code { background: none; padding: 0; }
        .markdown-body hr { border-color: #374151; margin: 1rem 0; }
        .markdown-body strong { color: #fbbf24; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="gradient-bg shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                    <h1 class="text-2xl font-bold text-white">Claude History Viewer</h1>
                </div>
                <div class="flex space-x-4">
                    <button onclick="showTab('projects')" id="tab-projects" class="tab-btn px-4 py-2 rounded-lg bg-white/20 text-white hover:bg-white/30 transition">
                        é¡¹ç›®åˆ—è¡¨
                    </button>
                    <button onclick="showTab('statistics')" id="tab-statistics" class="tab-btn px-4 py-2 rounded-lg text-white/80 hover:bg-white/20 transition">
                        æ•°æ®åˆ†æ
                    </button>
                    <button onclick="showTab('reports')" id="tab-reports" class="tab-btn px-4 py-2 rounded-lg text-white/80 hover:bg-white/20 transition">
                        åˆ†ææŠ¥å‘Š
                    </button>
                    <button onclick="showConfigModal()" class="px-4 py-2 rounded-lg text-white/80 hover:bg-white/20 transition" title="APIé…ç½®">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- é¡¹ç›®åˆ—è¡¨è§†å›¾ -->
        <div id="view-projects" class="fade-in">
            <div class="grid grid-cols-12 gap-6">
                <!-- å·¦ä¾§ï¼šé¡¹ç›®åˆ—è¡¨ -->
                <div class="col-span-3">
                    <div class="bg-gray-800 rounded-xl shadow-xl overflow-hidden">
                        <div class="p-4 border-b border-gray-700">
                            <h2 class="text-lg font-semibold flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                </svg>
                                é¡¹ç›®
                            </h2>
                        </div>
                        <div id="project-list" class="max-h-[calc(100vh-250px)] overflow-y-auto scrollbar-thin">
                            <div class="p-4 text-center text-gray-500">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- ä¸­é—´ï¼šä¼šè¯åˆ—è¡¨ -->
                <div class="col-span-3">
                    <div class="bg-gray-800 rounded-xl shadow-xl overflow-hidden">
                        <div class="p-4 border-b border-gray-700">
                            <h2 class="text-lg font-semibold flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"></path>
                                </svg>
                                ä¼šè¯
                            </h2>
                        </div>
                        <div id="session-list" class="max-h-[calc(100vh-250px)] overflow-y-auto scrollbar-thin">
                            <div class="p-4 text-center text-gray-500">è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®</div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šæ¶ˆæ¯è¯¦æƒ… -->
                <div class="col-span-6">
                    <div class="bg-gray-800 rounded-xl shadow-xl overflow-hidden">
                        <div class="p-4 border-b border-gray-700">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    å¯¹è¯å†…å®¹
                                </h2>
                                <div id="source-file-info" class="hidden">
                                    <button onclick="openSourceFile()" class="flex items-center text-xs text-blue-400 hover:text-blue-300 transition">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                        </svg>
                                        <span id="source-file-path" class="truncate max-w-xs" title=""></span>
                                    </button>
                                </div>
                                <button id="analyze-session-btn" onclick="analyzeCurrentSession()" class="hidden ml-2 px-3 py-1 bg-purple-600 hover:bg-purple-500 text-white text-xs rounded-lg transition flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                    AIåˆ†æ
                                </button>
                            </div>
                        </div>
                        <div id="message-list" class="max-h-[calc(100vh-250px)] overflow-y-auto scrollbar-thin p-4">
                            <div class="text-center text-gray-500">è¯·é€‰æ‹©ä¸€ä¸ªä¼šè¯æŸ¥çœ‹å¯¹è¯å†…å®¹</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡åˆ†æè§†å›¾ -->
        <div id="view-statistics" class="hidden fade-in">
            <!-- æ¦‚è§ˆå¡ç‰‡ -->
            <div class="grid grid-cols-4 gap-6 mb-6">
                <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-xl p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-200 text-sm">æ€»é¡¹ç›®æ•°</p>
                            <p id="stat-projects" class="text-3xl font-bold mt-1">-</p>
                        </div>
                        <svg class="w-12 h-12 text-purple-300/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-200 text-sm">æ€»ä¼šè¯æ•°</p>
                            <p id="stat-sessions" class="text-3xl font-bold mt-1">-</p>
                        </div>
                        <svg class="w-12 h-12 text-blue-300/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"></path>
                        </svg>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-xl p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-200 text-sm">æ€»æ¶ˆæ¯æ•°</p>
                            <p id="stat-messages" class="text-3xl font-bold mt-1">-</p>
                        </div>
                        <svg class="w-12 h-12 text-green-300/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                        </svg>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-orange-600 to-orange-800 rounded-xl p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-200 text-sm">å†å²è®°å½•</p>
                            <p id="stat-history" class="text-3xl font-bold mt-1">-</p>
                        </div>
                        <svg class="w-12 h-12 text-orange-300/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="bg-gray-800 rounded-xl p-6 card-hover">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        æ¯æ—¥æ´»åŠ¨è¶‹åŠ¿
                    </h3>
                    <canvas id="chart-daily"></canvas>
                </div>
                <div class="bg-gray-800 rounded-xl p-6 card-hover">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        æ¯å°æ—¶æ´»åŠ¨åˆ†å¸ƒ
                    </h3>
                    <canvas id="chart-hourly"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div class="bg-gray-800 rounded-xl p-6 card-hover">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                        å·¥å…·ä½¿ç”¨ç»Ÿè®¡
                    </h3>
                    <canvas id="chart-tools"></canvas>
                </div>
                <div class="bg-gray-800 rounded-xl p-6 card-hover">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        é¡¹ç›®æ´»è·ƒåº¦ Top 10
                    </h3>
                    <canvas id="chart-projects"></canvas>
                </div>
            </div>
        </div>

        <!-- åˆ†ææŠ¥å‘Šè§†å›¾ -->
        <div id="view-reports" class="hidden fade-in">
            <div class="mb-6">
                <h2 class="text-xl font-semibold flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    AIåˆ†ææŠ¥å‘Š
                </h2>
                <p class="text-gray-400 text-sm mt-1">æŸ¥çœ‹æ‰€æœ‰AIç”Ÿæˆçš„ç”¨æˆ·åå¥½åˆ†ææŠ¥å‘Š</p>
            </div>
            <div id="reports-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </main>

    <!-- é…ç½®å¼¹çª— -->
    <div id="config-modal" class="modal">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">APIé…ç½®</h3>
                <button onclick="closeConfigModal()" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">API Base URL</label>
                    <input type="text" id="config-base-url" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="https://api.openai.com/v1">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">API Key</label>
                    <input type="password" id="config-api-key" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="sk-...">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">æ¨¡å‹</label>
                    <input type="text" id="config-model" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="gpt-4o-mini">
                </div>
                <button onclick="saveConfig()" class="w-full bg-purple-600 hover:bg-purple-500 text-white py-2 rounded-lg transition">
                    ä¿å­˜é…ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- æŠ¥å‘Šå¼¹çª— -->
    <div id="report-modal" class="modal">
        <div class="bg-gray-800 rounded-xl w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                <h3 id="report-filename" class="text-lg font-semibold">åˆ†ææŠ¥å‘Š</h3>
                <button onclick="closeReportModal()" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="report-content" class="p-6 overflow-y-auto markdown-body">
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let currentProjectId = null;
        let currentSessionId = null;
        let currentSourceFile = null;
        let charts = {};

        // æ ¼å¼åŒ–æ—¶é—´æˆ³
        function formatTimestamp(ts) {
            if (!ts) return '-';
            const date = new Date(ts);
            return date.toLocaleString('zh-CN');
        }

        // æˆªæ–­æ–‡æœ¬
        function truncate(text, maxLength = 50) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // è½¬ä¹‰HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ‰“å¼€æºæ–‡ä»¶
        function openSourceFile() {
            if (currentSourceFile) {
                // å¤åˆ¶è·¯å¾„åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(currentSourceFile).then(() => {
                    alert('æºæ–‡ä»¶è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿:\n' + currentSourceFile);
                }).catch(() => {
                    prompt('æºæ–‡ä»¶è·¯å¾„:', currentSourceFile);
                });
            }
        }

        // åˆ é™¤ä¼šè¯
        async function deleteSession(projectId, sessionId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¼šè¯ ${sessionId.substring(0, 8)}... å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectId}/sessions/${sessionId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    // åˆ·æ–°ä¼šè¯åˆ—è¡¨
                    loadSessions(projectId);
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ˜¾ç¤ºçš„ä¼šè¯ï¼Œæ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
                    if (currentSessionId === sessionId) {
                        currentSessionId = null;
                        document.getElementById('message-list').innerHTML =
                            '<div class="text-center text-gray-500">è¯·é€‰æ‹©ä¸€ä¸ªä¼šè¯æŸ¥çœ‹å¯¹è¯å†…å®¹</div>';
                        document.getElementById('source-file-info').classList.add('hidden');
                    }
                    // åˆ·æ–°é¡¹ç›®åˆ—è¡¨ä»¥æ›´æ–°ä¼šè¯è®¡æ•°
                    loadProjects();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (result.errors?.join(', ') || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤é¡¹ç›®
        async function deleteProject(projectId, projectName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é¡¹ç›® "${projectName}" åŠå…¶æ‰€æœ‰ä¼šè¯å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    // åˆ·æ–°é¡¹ç›®åˆ—è¡¨
                    loadProjects();
                    // æ¸…ç©ºä¼šè¯å’Œæ¶ˆæ¯åŒºåŸŸ
                    if (currentProjectId === projectId) {
                        currentProjectId = null;
                        currentSessionId = null;
                        document.getElementById('session-list').innerHTML =
                            '<div class="p-4 text-center text-gray-500">è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®</div>';
                        document.getElementById('message-list').innerHTML =
                            '<div class="text-center text-gray-500">è¯·é€‰æ‹©ä¸€ä¸ªä¼šè¯æŸ¥çœ‹å¯¹è¯å†…å®¹</div>';
                        document.getElementById('source-file-info').classList.add('hidden');
                    }
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤é¡¹ç›®å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-white/20');
                btn.classList.add('text-white/80');
            });
            document.getElementById(`tab-${tab}`).classList.add('bg-white/20');
            document.getElementById(`tab-${tab}`).classList.remove('text-white/80');

            document.getElementById('view-projects').classList.add('hidden');
            document.getElementById('view-statistics').classList.add('hidden');
            document.getElementById('view-reports').classList.add('hidden');
            document.getElementById(`view-${tab}`).classList.remove('hidden');

            if (tab === 'statistics') {
                loadStatistics();
            } else if (tab === 'reports') {
                loadReports();
            }
        }

        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();

                const container = document.getElementById('project-list');
                if (projects.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-gray-500">æš‚æ— é¡¹ç›®</div>';
                    return;
                }

                container.innerHTML = projects.map(project => `
                    <div class="p-3 border-b border-gray-700 hover:bg-gray-700/50 cursor-pointer transition group"
                         onclick="loadSessions('${project.id}')">
                        <div class="flex items-center justify-between">
                            <div class="font-medium text-sm truncate" title="${escapeHtml(project.name)}">
                                ${escapeHtml(truncate(project.name, 25))}
                            </div>
                            <button onclick="event.stopPropagation(); deleteProject('${project.id}', '${escapeHtml(project.name).replace(/'/g, "\\'")}')"
                                    class="opacity-0 group-hover:opacity-100 p-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded transition"
                                    title="åˆ é™¤æ­¤é¡¹ç›®">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            ${project.session_count} ä¸ªä¼šè¯
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
                document.getElementById('project-list').innerHTML =
                    '<div class="p-4 text-center text-red-400">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        async function loadSessions(projectId) {
            currentProjectId = projectId;
            currentSessionId = null;

            document.getElementById('message-list').innerHTML =
                '<div class="text-center text-gray-500">è¯·é€‰æ‹©ä¸€ä¸ªä¼šè¯æŸ¥çœ‹å¯¹è¯å†…å®¹</div>';

            try {
                const response = await fetch(`/api/projects/${projectId}/sessions`);
                const sessions = await response.json();

                const container = document.getElementById('session-list');
                if (sessions.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-gray-500">æš‚æ— ä¼šè¯</div>';
                    return;
                }

                container.innerHTML = sessions.map(session => `
                    <div class="p-3 border-b border-gray-700 hover:bg-gray-700/50 cursor-pointer transition group"
                         onclick="loadMessages('${projectId}', '${session.id}')">
                        <div class="flex items-center justify-between">
                            <div class="font-medium text-sm truncate text-blue-400">
                                ${session.id.substring(0, 8)}...
                            </div>
                            <button onclick="event.stopPropagation(); deleteSession('${projectId}', '${session.id}')"
                                    class="opacity-0 group-hover:opacity-100 p-1 text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded transition"
                                    title="åˆ é™¤æ­¤ä¼šè¯">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            ${session.message_count} æ¡æ¶ˆæ¯
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${formatTimestamp(session.last_timestamp)}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
                document.getElementById('session-list').innerHTML =
                    '<div class="p-4 text-center text-red-400">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åŠ è½½æ¶ˆæ¯åˆ—è¡¨
        async function loadMessages(projectId, sessionId) {
            currentSessionId = sessionId;

            try {
                const response = await fetch(`/api/projects/${projectId}/sessions/${sessionId}`);
                const data = await response.json();
                const messages = data.messages || [];

                // æ›´æ–°æºæ–‡ä»¶ä¿¡æ¯
                currentSourceFile = data.source_file;
                const sourceFileInfo = document.getElementById('source-file-info');
                const sourceFilePath = document.getElementById('source-file-path');
                if (currentSourceFile) {
                    sourceFileInfo.classList.remove('hidden');
                    sourceFilePath.textContent = truncate(currentSourceFile, 40);
                    sourceFilePath.title = currentSourceFile;
                } else {
                    sourceFileInfo.classList.add('hidden');
                }

                const container = document.getElementById('message-list');
                if (messages.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500">æš‚æ— æ¶ˆæ¯</div>';
                    return;
                }

                container.innerHTML = messages.map(msg => `
                    <div class="mb-4 fade-in ${msg.type === 'user' ? 'ml-8' : 'mr-8'}">
                        <div class="flex items-center mb-1 flex-wrap gap-1">
                            <span class="text-xs font-medium ${msg.type === 'user' ? 'text-blue-400' : 'text-green-400'}">
                                ${msg.type === 'user' ? 'ç”¨æˆ·' : 'Claude'}
                            </span>
                            ${msg.model ? `<span class="text-xs text-purple-400 bg-purple-900/30 px-1.5 py-0.5 rounded">${escapeHtml(msg.model)}</span>` : ''}
                            <span class="text-xs text-gray-500 ml-2">
                                ${formatTimestamp(msg.timestamp)}
                            </span>
                            ${msg.cwd ? `<span class="text-xs text-gray-600 ml-2" title="${escapeHtml(msg.cwd)}">ğŸ“ ${escapeHtml(truncate(msg.cwd, 30))}</span>` : ''}
                        </div>
                        <div class="p-3 rounded-lg ${msg.type === 'user' ? 'bg-blue-900/30 border border-blue-800' : 'bg-gray-700/50 border border-gray-600'}">
                            <div class="message-content text-sm">${escapeHtml(msg.content)}</div>
                        </div>
                    </div>
                `).join('');

                // æ˜¾ç¤ºAIåˆ†ææŒ‰é’®
                document.getElementById('analyze-session-btn').classList.remove('hidden');

                container.scrollTop = 0;
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                document.getElementById('message-list').innerHTML =
                    '<div class="text-center text-red-400">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const stats = await response.json();

                // æ›´æ–°æ¦‚è§ˆæ•°å­—
                document.getElementById('stat-projects').textContent = stats.total_projects;
                document.getElementById('stat-sessions').textContent = stats.total_sessions;
                document.getElementById('stat-messages').textContent = stats.total_messages;
                document.getElementById('stat-history').textContent = stats.total_history_entries;

                // ç»˜åˆ¶å›¾è¡¨
                renderDailyChart(stats.daily_activity);
                renderHourlyChart(stats.hourly_activity);
                renderToolsChart(stats.tool_usage);
                renderProjectsChart(stats.projects_by_activity);
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // ç»˜åˆ¶æ¯æ—¥æ´»åŠ¨å›¾è¡¨
        function renderDailyChart(data) {
            const ctx = document.getElementById('chart-daily').getContext('2d');
            if (charts.daily) charts.daily.destroy();

            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'æ´»åŠ¨æ¬¡æ•°',
                        data: Object.values(data),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                        y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }
                    }
                }
            });
        }

        // ç»˜åˆ¶æ¯å°æ—¶æ´»åŠ¨å›¾è¡¨
        function renderHourlyChart(data) {
            const ctx = document.getElementById('chart-hourly').getContext('2d');
            if (charts.hourly) charts.hourly.destroy();

            const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
            const values = labels.map((_, i) => data[i] || 0);

            charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ´»åŠ¨æ¬¡æ•°',
                        data: values,
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                        y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }
                    }
                }
            });
        }

        // ç»˜åˆ¶å·¥å…·ä½¿ç”¨å›¾è¡¨
        function renderToolsChart(data) {
            const ctx = document.getElementById('chart-tools').getContext('2d');
            if (charts.tools) charts.tools.destroy();

            const entries = Object.entries(data).slice(0, 10);
            charts.tools = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: entries.map(e => e[0]),
                    datasets: [{
                        data: entries.map(e => e[1]),
                        backgroundColor: [
                            '#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6',
                            '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        // ç»˜åˆ¶é¡¹ç›®æ´»è·ƒåº¦å›¾è¡¨
        function renderProjectsChart(data) {
            const ctx = document.getElementById('chart-projects').getContext('2d');
            if (charts.projects) charts.projects.destroy();

            charts.projects = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(p => truncate(p.name, 20)),
                    datasets: [{
                        label: 'æ¶ˆæ¯æ•°',
                        data: data.map(p => p.messages),
                        backgroundColor: '#f97316'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
                        y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }
                    }
                }
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            checkConfig();
        });

        // æ£€æŸ¥APIé…ç½®
        async function checkConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                if (!config.configured) {
                    console.log('APIæœªé…ç½®ï¼ŒAIåˆ†æåŠŸèƒ½ä¸å¯ç”¨');
                }
            } catch (error) {
                console.error('æ£€æŸ¥é…ç½®å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºé…ç½®å¼¹çª—
        async function showConfigModal() {
            const modal = document.getElementById('config-modal');
            modal.classList.add('active');

            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                document.getElementById('config-base-url').value = config.base_url || 'https://api.openai.com/v1';
                document.getElementById('config-model').value = config.model || 'gpt-4o-mini';
                document.getElementById('config-api-key').value = '';
                document.getElementById('config-api-key').placeholder = config.configured ? 'å·²é…ç½® (ç•™ç©ºä¿æŒä¸å˜)' : 'è¯·è¾“å…¥APIå¯†é’¥';
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // å…³é—­é…ç½®å¼¹çª—
        function closeConfigModal() {
            document.getElementById('config-modal').classList.remove('active');
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const apiKey = document.getElementById('config-api-key').value;
            const baseUrl = document.getElementById('config-base-url').value;
            const model = document.getElementById('config-model').value;

            if (!apiKey) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: apiKey, base_url: baseUrl, model: model })
                });
                const result = await response.json();
                if (result.success) {
                    alert('é…ç½®ä¿å­˜æˆåŠŸ');
                    closeConfigModal();
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // åˆ†æå½“å‰ä¼šè¯
        async function analyzeCurrentSession() {
            if (!currentProjectId || !currentSessionId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼šè¯');
                return;
            }

            const btn = document.getElementById('analyze-session-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="w-4 h-4 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>åˆ†æä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch(`/api/analyze/${currentProjectId}/sessions/${currentSessionId}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showReportModal(result.report, result.report_file);
                } else {
                    alert('åˆ†æå¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                alert('åˆ†æå¤±è´¥: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // æ˜¾ç¤ºæŠ¥å‘Šå¼¹çª—
        function showReportModal(content, filename) {
            const modal = document.getElementById('report-modal');
            const reportContent = document.getElementById('report-content');
            const reportFilename = document.getElementById('report-filename');

            reportFilename.textContent = filename || 'åˆ†ææŠ¥å‘Š';
            reportContent.innerHTML = marked.parse(content);
            modal.classList.add('active');
        }

        // å…³é—­æŠ¥å‘Šå¼¹çª—
        function closeReportModal() {
            document.getElementById('report-modal').classList.remove('active');
        }

        // åŠ è½½æŠ¥å‘Šåˆ—è¡¨
        async function loadReports() {
            try {
                const response = await fetch('/api/reports');
                const reports = await response.json();

                const container = document.getElementById('reports-list');
                if (reports.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— åˆ†ææŠ¥å‘Š</div>';
                    return;
                }

                container.innerHTML = reports.map(report => `
                    <div class="bg-gray-800 rounded-lg p-4 card-hover cursor-pointer" onclick="viewReport('${report.filename}')">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <svg class="w-8 h-8 text-purple-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div>
                                    <div class="font-medium">${report.filename}</div>
                                    <div class="text-xs text-gray-400">${new Date(report.created).toLocaleString('zh-CN')}</div>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); deleteReport('${report.filename}')" class="p-2 text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æŠ¥å‘Šåˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('reports-list').innerHTML = '<div class="text-center text-red-400">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æŸ¥çœ‹æŠ¥å‘Š
        async function viewReport(filename) {
            try {
                const response = await fetch(`/api/reports/${filename}`);
                const result = await response.json();
                showReportModal(result.content, result.filename);
            } catch (error) {
                console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', error);
                alert('åŠ è½½æŠ¥å‘Šå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤æŠ¥å‘Š
        async function deleteReport(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æŠ¥å‘Š "${filename}" å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/reports/${filename}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    loadReports();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤æŠ¥å‘Šå¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
